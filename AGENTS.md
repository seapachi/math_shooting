# AGENTS.md

## 目的
このリポジトリでのAI作業ルールと制約を定義する。

## 必須ドキュメント
- ソースコード（`index.html`, `styles.css`, `*.js` など）に変更を加えるたびに、必ず `EXPLANATION.md` を更新する。
- `README.md`、`AGENTS.md`、`PLAN.md` のみを変更する場合、`EXPLANATION.md` の更新は必須ではない。
- `EXPLANATION.md` には、プロジェクト全体を平易な日本語で説明する。

## 作業範囲
- 変更して良い: `index.html`, `styles.css`, `game-settings.js`, `EXPLANATION.md`, `README.md`, `AGENTS.md`, `PLAN.md`
- 変更しない: `node_modules/`、ビルド/生成物（例: `dist/`, `build/`）

## コーディング規約
- 既存の命名とスタイルに合わせる。
- 明瞭さを優先し、最小限で目的に沿った変更を行う。

## テスト / ビルド
- 利用可能で変更に関係する場合のみ、テストやビルドを実行する。

## コミット方針
- コミットメッセージは日本語にする。
- コミットは小さく、目的を一つに絞る。
- コミット実行前にユーザーへ確認し、承認後に実行する。

## 注意事項
- 機密情報やAPIキーは追加しない。
- 外部ネットワークアクセスが必要な場合は事前に相談する。

## 事前確認ルール（必須）
- 機能追加・仕様変更・挙動変更の相談時は、修正前に要件（目的、対象ファイル、期待動作、完了条件）を確認する。
- 不明点がある間は編集せず、要件整理後に「この内容で修正を開始してよいですか？」と確認し、ユーザーの明示的な承認後に着手する。

## タスク進捗管理（必須）
- タスク進捗は `PLAN.md` に記録する。
- 実行開始前に `PLAN.md` を確認し、対象タスクと状態を把握する。
- 進捗状態は `未着手 / 進行中 / 完了 / 保留` のいずれかで管理する。
- 状態や対象範囲が変わったら、その都度 `PLAN.md` を更新してから作業を続行する。
- 複数タスクは 1 件ずつ進め、完了したら次タスクへ進む。

## 画面サイズ前提
- ゲーム画面の設計基準は縦向き `390 x 844`（CSS px）とする。

## 文字コードルール（重要）
- テキストファイルは必ず UTF-8 で保存する（BOMなし推奨）。
- `Shift_JIS / CP932 / UTF-16` で保存しない。
- 対象: `*.html`, `*.css`, `*.md`, `*.js`, `*.json`
- 文字化けしている状態でコミットしない。
- GitHub Pages で `invalid characters for the used encoding UTF-8` が出た場合は、該当ファイルをUTF-8で再保存して再デプロイする。

## プレビュー確認ルール（追加）
- 画面表示（UIレイアウト・見た目）に関わる変更を行う場合は、作業後に必ずプレビュー表示（スクリーンショット取得を含む）を実施する。
- 可能な限り `browser` ツールで確認し、引き算モードの画面を取得を試み、取得できない場合は失敗理由を作業報告に明記する。

## スクリーンショット取得手順（安定運用）
- スクリーンショット前に、ローカルサーバー起動後 `curl -I http://127.0.0.1:8000/index.html` で疎通確認（HTTP 200）を行う。
- `run_playwright_script` の `screenshot(path=...)` は単純な相対パス（例: `question-panel.png`）を使い、`artifacts/...` の多段パスは避ける。
- 撮影は「ページ表示待機 → 引き算モード開始操作 → 短い待機 → 撮影」の順で行う。
- 画像ファイル名は毎回ユニークにし、上書きやキャッシュ混同を避ける（例: タイムスタンプ付き）。
- 判定は2段階で行う:
  1. `run_playwright_script` が `browser:/...` のartifact URIを返すこと
  2. `open_image_artifact` で表示確認できること
- 2 が失敗した場合でも 1 が成功していれば「撮影成功・ビューア表示失敗」として扱い、失敗理由を作業報告に明記する。
- 最終報告には、取得したartifact URIをMarkdown画像リンクで必ず添付する。


## マージ前チェック（競合回避）（必須）
- PR作成前に、対象外ファイルの差分が含まれていないか確認する（例: ルール修正PRなら `AGENTS.md` / `PLAN.md` のみ）。
- `マージできません` が表示された場合は、先にベースブランチ最新を取り込んで競合解消してからPRを更新する。
- 競合が発生したファイルは、今回タスクで必要な変更だけを残し、それ以外はベース側に合わせる。
