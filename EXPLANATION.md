# EXPLANATION.md

## このファイルの目的
この文書は、`Math Lane Shooter` の全体構成を初心者向けに説明するためのガイドです。  
「どこを見れば何が分かるか」を短時間で把握できるように整理しています。

## プロジェクトの概要
`Math Lane Shooter` は、計算問題と4レーンシューティングを組み合わせたブラウザゲームです。

- レンダリングとゲーム進行: `Phaser 3`（CDN読み込み）
- 画面デザイン: `styles.css`
- 実行の中心: `index.html`（HTML + JavaScript）

## ファイル構成
- `index.html`
  - ゲーム本体（シーン、入力、描画、当たり判定、問題生成）
- `styles.css`
  - 背景、配色、UI装飾、レスポンシブ表示
- `reference/font-size-compare.html`
  - フォント調整前に見た目を比較する確認用サンプル
- `EXPLANATION.md`
  - この解説ドキュメント
- `README.md`
  - 利用者向けの概要説明
- `AGENTS.md`
  - AI作業ルール

## 画面とシーンの流れ
`index.html` 内で、Phaserのシーンを使って画面遷移しています。

1. `BootScene`
   - 共有テクスチャ（背景、弾、敵、宇宙船）を先に作る準備シーン
2. `StartScene`
   - タイトル画面
   - 機体デザイン切替（`sharp` / `flare`）
   - モード選択（`足し算 / 引き算 / 掛け算`）
   - `START` 押下で `GameScene` へ
3. `GameScene`
   - 問題表示、敵落下、発射、判定、スコア・ライフ管理
4. `ResultScene`
   - 最終スコア表示、再挑戦導線

## 計算問題の作り方
`makeQuestion(mode)` がモードに応じて次の関数を呼びます。

- `makeAddQuestion()`
  - 0〜9 + 0〜9（正解は0〜18）
- `makeSubQuestion()`
  - 引き算（負数を避けるように調整）
- `makeMulQuestion()`
  - 1〜9 × 1〜9

問題文と正解に加えて、誤答候補を作り、4レーンに割り当てます。

## ゲーム進行の考え方
- プレイヤーは4レーン間を移動
- 敵（数字入りブロック）が上から落下
- 正しい数字の敵にショットを当てると得点（着弾エリアで点数が変化）
- 不正解ヒットや見逃しでライフ減少
- ライフが0になると終了

### 正解時の得点ルール（着弾エリア）
`GameScene` では画面を縦3エリアに分け、弾が当たった位置で加点を決めています。

- Area3（上）: `+3`
- Area2（中央）: `+2`
- Area1（下）: `+1`

境界は次の2本線です。

- Area2/Area1 境界: 既存の `LOCK LINE`（`judgeY`）
- Area3/Area2 境界: `judgeY / 2`

※ AUTO判定（敵がLOCK LINE到達時の判定）は維持され、正解時は `+1` です。

## 入力操作
- タップ: レーン移動
- 左右スワイプ: レーン移動
- ダブルタップ: 発射
- 右上ボタン: 一時停止/再開

## デザインの役割分担
- `index.html`
  - Phaser内で描く文字・図形・座標・アニメーション
- `styles.css`
  - ページ背景、枠、グロー、全体トーン

### iOS Chrome の表示差分対策（上下見切れ防止）
iPhone の Chrome は、アドレスバーやツールバーの表示状態で「見えている高さ」が変わることがあります。  
この差分で `100vh` が実画面とずれると、上下が欠けて見える場合があります。

このプロジェクトでは、次の方法で高さを同期しています。

- `styles.css`
  - `:root` に `--app-height` を用意
  - `#game` は `height: 100vh;` の後に `height: var(--app-height);` を指定
- `index.html`
  - `syncAppHeight()` で `window.visualViewport?.height` を優先取得（未対応時は `window.innerHeight`）
  - 取得した高さを `--app-height` に反映
  - 高さ更新後に `game.scale.refresh()` を呼んで、Phaser の `FIT` レイアウトを再計算
  - `resize` / `orientationchange`（必要に応じて `visualViewport` の `resize` / `scroll`）で再同期

この変更はレイアウト制御のみで、得点・ライフ・入力操作などのゲームルールは変更していません。


### HUDパネル（SCORE / SPEED / LIFE）調整
`GameScene.create()` の情報パネルを、参照SVGに寄せたサイズと配色に更新しています。

- SCORE: 左上寄り（起点 x=30, y=150 相当）、`220 x 65`
- SPEED: SCOREの下（起点 x=30, y=235 相当）、`180 x 58`
- LIFE: 右側、`220 x 65`
- パネル枠色は役割ごとに固定
  - SCORE: `#ff8800`
  - SPEED: `#00ffff`
  - LIFE: `#00ffaa`
- フォントは `FONT_ENEMY`（Rajdhani）中心で太字・大きめサイズ
- 各パネルに縦アクセント線を `Graphics.lineBetween()` で追加

LIFE表示は従来のハート文字を廃止し、次の構成へ置き換えました。

- `LIFE: n` のテキスト表示
- 3本の縦バー（`rectangle`）
- 残ライフ数に応じてバー色を更新（有効: 明るい緑 / 失効: 暗色）

この変更は見た目と情報表示方法の更新で、ライフの減少条件やゲーム進行ロジックは維持しています。



### 狭い画面でのHUD重なり対策
スマートフォン縦画面などで `SCORE` と `LIFE` パネルが重ならないよう、`GameScene.create()` のHUD配置を可変化しました。

- 画面幅から「左右マージン + 2パネル + すき間」を計算し、足りない場合は `SCORE` と `LIFE` の幅を同率で縮小
- パネル幅に連動して `SCORE` / `LIFE` の文字サイズも自動調整
- `LIFE` テキストを左寄せ、ライフバーを右端寄せにして、狭幅時でもテキストとバーがぶつかりにくい配置に変更
- 枠色、アクセント線、表示仕様（`LIFE: n` + 3本バー）は維持

これにより、参照デザインの雰囲気を保ったまま、画面幅が小さい端末でもHUDの重なりが発生しにくくなります。



### HUDの縦幅縮小と横一列レイアウト
HUDパネルをさらに調整し、`SCORE / SPEED / LIFE` を上段に横一列で並べる構成に変更しました。

- 各パネルの縦幅を `65px/58px` 系から `52px` に縮小
- `SCORE / SPEED / LIFE` を同じY座標に再配置（上段1列）
- 画面幅に応じて3パネルの横幅を比率配分し、狭い端末でも1列を維持
- `LIFE` の3本バーも小型化し、パネル内に収まるよう調整
- 役割色（SCORE: オレンジ / SPEED: シアン / LIFE: グリーン）とアクセント線は維持

この変更で、HUDの占有高さを減らしつつ、情報を上部にまとめて見やすくしています。



### HUDラベル短縮（A案）と等幅パネル
文字のはみ出し対策として、HUDの上段ラベルを A案で短縮しました。

- `SCORE` → `SCR`
- `SPEED` → `SPD`
- `LIFE` → `LIF`

さらに、上段の `SCORE / SPEED / LIFE` 3パネルは同じ幅で並ぶように統一しています。
これにより、見た目のバランスを保ちながら、狭い画面での文字はみ出しを起こしにくくしています。


### LIFE表示（`LIF:` ラベル + 3本バー）
LIFEパネルは `LIF:` ラベルを左側に表示し、右側に3本のバーを配置する構成です。

- テキストは `LIF:` のみ表示（数値は表示しない）
- `LIF:` ラベルのフォントサイズは `SCORE` / `SPD` と同等サイズへ統一
- 残機バーは右側に縦3本で表示
- ライフが減るたびに、**上のバーから順に白抜き**（中抜き）へ切り替え
- 被弾/見逃し時のフィードバックはバー全体へパルス演出を適用

この変更により、ラベルの意味を残しつつ、狭幅画面でも視認しやすい残機表現にしています。

### フォントの見やすさ改善
`GameScene` 内の表示を次のように調整しています。

- 問題文（上部）: `32px -> 38px`
- 敵数字（選択肢）: `24px -> 28px`
- 文字色は既存のまま（問題文 `#7dd3fc`、敵数字 `#fbbf24`）
- 暗い背景でも輪郭が埋もれにくいように、縁取りと影を調整

見た目を変えるときは、まず `styles.css` の色変数を確認し、次に `index.html` の Phaser描画色を合わせると管理しやすくなります。

## 初心者向けの読み順
1. `index.html` の定数（色、フォント、レーン設定）
2. `makeQuestion()` と各モード問題生成関数
3. `StartScene`（モード選択UI）
4. `GameScene`（生成・移動・衝突・スコア）
5. `styles.css`（最終的な見た目調整）

## 変更時の基本チェック
- モード選択UIと実際の出題内容が一致しているか
- スコア・ライフの増減条件が意図通りか
- モバイル表示でUIが重なっていないか
- 文字コードがUTF-8で保存されているか（GitHub Pages対策）


### 問題表示パネルの強調デザイン
`GameScene.create()` の問題表示（`this.questionText`）まわりを、参照イメージに合わせて強調しました。

- 画面上部中央のやや下（画面高さの約22%）へ問題表示を移動
- `Graphics` で半透明背景 + シアン枠の外枠を追加
- 四隅にL字アクセントを `lineBetween()` で描画
- 問題文フォントは `FONT_ENEMY` のまま、サイズを `60px` に拡大
- 文字色をシアン寄り（`#99f6ff`）に変更し、`shadow` を強めてグローを強化

この変更は見た目の強調が目的で、出題ロジックや正誤判定などのゲームルールは変更していません。
