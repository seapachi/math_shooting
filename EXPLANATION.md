# EXPLANATION.md

## このファイルの目的
この文書は、`Math Lane Shooter` の全体構成を初心者向けに説明するためのガイドです。  
「どこを見れば何が分かるか」を短時間で把握できるように整理しています。

## プロジェクトの概要
`Math Lane Shooter` は、計算問題と4レーンシューティングを組み合わせたブラウザゲームです。

- レンダリングとゲーム進行: `Phaser 3`（CDN読み込み）
- 画面デザイン: `styles.css`
- 実行の中心: `index.html`（HTML + JavaScript）

## ファイル構成
- `index.html`
  - ゲーム本体（シーン、入力、描画、当たり判定、問題生成）
- `game-settings.js`
  - ゲーム設定（落下速度、連続正解条件、出題範囲）
- `styles.css`
  - 背景、配色、UI装飾、レスポンシブ表示
- `reference/font-size-compare.html`
  - フォント調整前に見た目を比較する確認用サンプル
- `EXPLANATION.md`
  - この解説ドキュメント
- `README.md`
  - 利用者向けの概要説明
- `AGENTS.md`
  - AI作業ルール

## 画面とシーンの流れ
`index.html` 内で、Phaserのシーンを使って画面遷移しています。

1. `BootScene`
   - 共有テクスチャ（背景、弾、敵、宇宙船）を先に作る準備シーン
2. `StartScene`
   - タイトル画面
   - 機体デザイン切替（`sharp` / `flare`）
   - モード選択（`足し算 / 引き算 / 掛け算`）
   - `START` 押下で `GameScene` へ
3. `GameScene`
   - 問題表示、敵落下、発射、判定、スコア・ライフ管理
4. `ResultScene`
   - 最終スコア表示、再挑戦導線

## 計算問題の作り方
`makeQuestion(mode)` がモードに応じて次の関数を呼びます。  
各モードの出題範囲（`aMin/aMax`, `bMin/bMax`）は `game-settings.js` の `window.GAME_SETTINGS.question` で変更できます。

- `makeAddQuestion()`
  - 足し算の範囲を設定から読み取り（例: 0〜9 + 0〜9）
- `makeSubQuestion()`
  - 引き算の範囲を設定から読み取り（負数を避けるように調整）
- `makeMulQuestion()`
  - 掛け算の範囲を設定から読み取り（例: 1〜9 × 1〜9）

問題文と正解に加えて、誤答候補を作り、4レーンに割り当てます。

## ゲーム進行の考え方
- プレイヤーは4レーン間を移動
- 敵（数字入りブロック）が上から落下
- 正しい数字の敵にショットを当てると得点（着弾エリアで点数が変化）
- 不正解ヒットや見逃しでライフ減少
- 連続正解が設定回数（既定: 3回）に達するたびに落下スピードが1段階上昇
- ライフが0になると終了

速度設定は `game-settings.js` の `window.GAME_SETTINGS.speed` で変更できます。

- `increaseStep`: 速度の上がり幅
- `streakToIncrease`: 何問連続正解で速度を上げるか
- `base`: 初期速度
- `max`: 最大速度

### 正解時の得点ルール（着弾エリア）
`GameScene` では画面を縦3エリアに分け、弾が当たった位置で加点を決めています。

- Area3（上）: `+3`
- Area2（中央）: `+2`
- Area1（下）: `+1`

境界は次の2本線です。

- Area2/Area1 境界: 既存の `LOCK LINE`（`judgeY`）
- Area3/Area2 境界: `judgeY / 2`

※ AUTO判定（敵がLOCK LINE到達時の判定）は維持され、正解時は `+1` です。

## 入力操作
- タップ: レーン移動
- 左右スワイプ: レーン移動
- ダブルタップ: 発射
- 右上ボタン: 一時停止/再開

## デザインの役割分担
- `index.html`
  - Phaser内で描く文字・図形・座標・アニメーション
- `styles.css`
  - ページ背景、枠、グロー、全体トーン

### スマホChromeの表示差分・タップ無反応対策
iPhone/Android の Chrome は、アドレスバーやツールバーの表示状態で「見えている高さ」が細かく変わることがあります。  
このとき高さ再計算（`scale.refresh()`）が過剰に走ると、タップ中に入力座標がずれて「押しても反応しない」ように見えることがあります。

このプロジェクトでは、次の方法で高さ同期と入力面を安定化しています。

- `styles.css`
  - `:root` に `--app-height` を用意
  - `#game` は `height: 100vh;` の後に `height: var(--app-height);` を指定
  - `#game canvas` に `touch-action: none` と `pointer-events: auto` を明示
  - `-webkit-tap-highlight-color: transparent` / `user-select: none` などを指定し、タップ時のブラウザ側干渉を減らす
- `index.html`
  - `syncAppHeight()` で `window.visualViewport` の `width/height`（未対応時は `innerWidth/innerHeight`）を取得
  - 前回値と同じなら更新しない（差分があるときだけ `--app-height` 更新 + `game.scale.refresh()`）
  - 監視イベントは `resize` / `orientationchange` / `visualViewport.resize` に限定し、`visualViewport.scroll` 連動は外す
  - 起動後に Phaser の `canvas` へ入力安定化スタイルを直接適用

この変更は入力の取りこぼし防止とレイアウト同期の安定化が目的で、得点・ライフ・操作ルール自体（タップ移動/スワイプ移動/ダブルタップ発射）は変更していません。

### タイトル画面のみ無反応対策（UA分岐なし）
実機で「ゲーム画面は反応するが、タイトル画面だけタップが効かない」症状に対して、`StartScene` の入力処理にフォールバックを追加しています。

- 既存の `setInteractive + pointerdown` はそのまま維持
- `this.input.on("pointerdown", (pointer, currentlyOver) => { ... })` を追加
- `currentlyOver` に対象があるときは既存のヒット判定を優先して何もしない
- `currentlyOver` が空のときだけ、`GameObject.getBounds()` で座標判定して次を実行
  - `START`
  - `SHIP` 切替
  - `足し算 / 引き算 / 掛け算` 切替
- `START` は `startTriggered` フラグで多重起動を防止

この対応は **ブラウザUA判定を使わず** に、タイトル画面入力の取りこぼしを補うことが目的です。  
ゲームルール（得点・ライフ・速度・出題）には変更を加えていません。


### HUDパネル（SCORE / SPEED / LIFE）調整
`GameScene.create()` の情報パネルを、参照SVGに寄せたサイズと配色に更新しています。

- SCORE: 左上寄り（起点 x=30, y=150 相当）、`220 x 65`
- SPEED: SCOREの下（起点 x=30, y=235 相当）、`180 x 58`
- LIFE: 右側、`220 x 65`
- パネル枠色は役割ごとに固定
  - SCORE: `#ff8800`
  - SPEED: `#00ffff`
  - LIFE: `#00ffaa`
- フォントは `FONT_ENEMY`（Rajdhani）中心で太字・大きめサイズ
- 各パネルに縦アクセント線を `Graphics.lineBetween()` で追加

LIFE表示は従来のハート文字を廃止し、次の構成へ置き換えました。

- `LIFE: n` のテキスト表示
- 3本の縦バー（`rectangle`）
- 残ライフ数に応じてバー色を更新（有効: 明るい緑 / 失効: 暗色）

この変更は見た目と情報表示方法の更新で、ライフの減少条件やゲーム進行ロジックは維持しています。



### 狭い画面でのHUD重なり対策
スマートフォン縦画面などで `SCORE` と `LIFE` パネルが重ならないよう、`GameScene.create()` のHUD配置を可変化しました。

- 画面幅から「左右マージン + 2パネル + すき間」を計算し、足りない場合は `SCORE` と `LIFE` の幅を同率で縮小
- パネル幅に連動して `SCORE` / `LIFE` の文字サイズも自動調整
- `LIFE` テキストを左寄せ、ライフバーを右端寄せにして、狭幅時でもテキストとバーがぶつかりにくい配置に変更
- 枠色、アクセント線、表示仕様（`LIFE: n` + 3本バー）は維持

これにより、参照デザインの雰囲気を保ったまま、画面幅が小さい端末でもHUDの重なりが発生しにくくなります。



### HUDの縦幅縮小と横一列レイアウト
HUDパネルをさらに調整し、`SCORE / SPEED / LIFE` を上段に横一列で並べる構成に変更しました。

- 各パネルの縦幅を `65px/58px` 系から `52px` に縮小
- `SCORE / SPEED / LIFE` を同じY座標に再配置（上段1列）
- 画面幅に応じて3パネルの横幅を比率配分し、狭い端末でも1列を維持
- `LIFE` の3本バーも小型化し、パネル内に収まるよう調整
- 役割色（SCORE: オレンジ / SPEED: シアン / LIFE: グリーン）とアクセント線は維持

この変更で、HUDの占有高さを減らしつつ、情報を上部にまとめて見やすくしています。



### HUDラベル短縮（A案）と等幅パネル
文字のはみ出し対策として、HUDの上段ラベルを A案で短縮しました。

- `SCORE` → `SCR`
- `SPEED` → `SPD`
- `LIFE` → `LIF`

さらに、上段の `SCORE / SPEED / LIFE` 3パネルは同じ幅で並ぶように統一しています。
これにより、見た目のバランスを保ちながら、狭い画面での文字はみ出しを起こしにくくしています。


### LIFE表示（`LIF:` ラベル + 3本バー）
LIFEパネルは `LIF:` ラベルを左側に表示し、右側に3本のバーを配置する構成です。

- テキストは `LIF:` のみ表示（数値は表示しない）
- `LIF:` ラベルのフォントサイズは `SCORE` / `SPD` と同等サイズへ統一
- 残機バーは右側に縦3本で表示
- ライフが減るたびに、**上のバーから順に白抜き**（中抜き）へ切り替え
- 被弾/見逃し時のフィードバックはバー全体へパルス演出を適用

この変更により、ラベルの意味を残しつつ、狭幅画面でも視認しやすい残機表現にしています。

### フォントの見やすさ改善
`GameScene` 内の表示を次のように調整しています。

- 問題文（上部）: `60px / 56px / 52px`（画面高さに応じた段階縮小、今回変更なし）
- 敵数字（選択肢）: `28px -> 32px`
- 文字色は既存のまま（問題文 `#7dd3fc`、敵数字 `#fbbf24`）
- 暗い背景でも輪郭が埋もれにくいように、縁取りと影を調整

### 初回表示フォント揺れ対策
初回の問題だけ文字サイズが違って見えることがあったため、ゲーム起動前のフォント待機を追加しました。

- 原因: `Phaser.Game` 起動時にWebフォント（Rajdhani）が未読み込みだと、最初の問題だけ代替フォントで描画されることがある
- 対策: `document.fonts.load()` で Rajdhani の使用サイズ帯（`60/56/52/32px`）を待ってからゲームを起動
- タイムアウト: 最大 `2500ms` 待機し、間に合わない場合は `console.warn` を出して起動を継続

見た目を変えるときは、まず `styles.css` の色変数を確認し、次に `index.html` の Phaser描画色を合わせると管理しやすくなります。

## 初心者向けの読み順
1. `index.html` の定数（色、フォント、レーン設定）
2. `makeQuestion()` と各モード問題生成関数
3. `StartScene`（モード選択UI）
4. `GameScene`（生成・移動・衝突・スコア）
5. `styles.css`（最終的な見た目調整）

## 変更時の基本チェック
- モード選択UIと実際の出題内容が一致しているか
- スコア・ライフの増減条件が意図通りか
- モバイル表示でUIが重なっていないか
- 文字コードがUTF-8で保存されているか（GitHub Pages対策）


### 問題表示パネルの強調デザイン
`GameScene.create()` の問題表示（`this.questionText`）まわりを、参照イメージに合わせて強調しました。

- 画面上部中央で、HUDの下に問題表示を配置
- `Graphics` で半透明背景 + シアン枠の外枠を追加
- 四隅にL字アクセントを `lineBetween()` で描画
- 問題文フォントは `FONT_ENEMY` のまま、サイズを `60px` に拡大
- 文字色をシアン寄り（`#99f6ff`）に変更し、`shadow` を強めてグローを強化

この変更は見た目の強調が目的で、出題ロジックや正誤判定などのゲームルールは変更していません。

### 問題パネルの重なり回避（B+C）
HUDと問題パネルの縦位置ルールを見直し、重なりを防止しました。

- 縦並びは **上から HUD → 問題パネル** の順で固定
- 問題パネルのY座標を「HUD下端 + 16px + パネル半分」で計算し、常にHUDの下に配置
- 狭い画面向けに2段階の縮小ルールを追加
  - `h < 780`: パネル高さ `100px`、文字 `56px`、角L字 `20px`
  - `h < 700`: パネル高さ `92px`、文字 `52px`、角L字 `16px`
- 通常サイズ（上記以外）は従来どおり `110px / 60px / 24px`

この変更はレイアウトと見た目の調整で、問題生成や正誤判定のロジックは変更していません。

### HUD/問題パネルの縦位置調整（上方向へ移動）
390x844基準で上端の余白を見直し、HUDと問題パネルを少し上に詰めました。

- HUD基準Yを `148` から `132` に変更
- HUD直下の余白（`questionGapFromHud`）を `16` から `10` に変更
- 停止ボタンのY座標を `35` から `32` に変更

この調整により、停止ボタン〜HUD間の「空きすぎ感」を抑えつつ、問題パネルがHUDと重ならない配置を維持しています。ゲームロジック（問題生成、当たり判定、得点計算）は変更していません。

### ChromeでのSTART遷移調査ログ追加
タイトル画面で「STARTボタンは反応して見えるが、次画面へ進まない」症状を切り分けるため、`StartScene` と `GameScene` にコンソールログを追加しました。

- `StartScene` 側
  - STARTボタンの `pointerdown` 発火ログ
  - 既存フォールバック命中時（座標判定）の発火ログ
  - `start()` 開始ログ（起動元、選択中の機体/モード、`visibilityState`）
  - `SFX.resume()` 完了ログ
  - `scene.start("game")` 呼び出し直前ログ
  - `startTriggered` による二重起動抑止ログ
  - `StartScene` の `shutdown` ログ
- `GameScene` 側
  - `init(data)` 呼び出しログ（受け取った開始データ）
  - `create()` 呼び出しログ

この追加により、Chrome上で「押下イベントは来ているか」「音声resumeで止まっていないか」「`scene.start` が呼ばれているか」「GameScene側まで遷移しているか」を段階的に確認できます。

### iPhone単体で確認できるデバッグログパネル
iPhoneでMac接続なしでも調査できるよう、画面右下に小さな `LOG` ボタンを追加しました（`?debug=1` を付けると表示）。

- `LOG` を押すとデバッグパネルを開閉
- `CLEAR` でログを消去
- 既存のSTART遷移ログ（`StartScene` / `GameScene`）をパネル内にも表示
- `window.onerror` と `unhandledrejection` もパネルに表示
- 行数は最大80行で古いものから自動削除

これにより、iPhone単体で「START押下 → 音声resume → scene.start呼び出し → GameScene到達」のどこで止まっているかを確認しやすくなります。

### スマホだけで共有しやすいCOPY機能
DebugOverlayに `COPY` ボタンを追加しました。iPhoneなどでログ確認後、そのまま共有しやすくするための機能です。

- `COPY` でログ全体（最大80行）をクリップボードへコピー
- クリップボードAPIが使えない場合は `prompt` を開いて手動コピー可能
- コピー成功時はパネル内に `Log copied to clipboard` を追記

これにより、Mac接続なしでも、端末だけでログ採取→共有（チャット貼り付け）がしやすくなります。


### START遷移時の音声resume待機タイムアウト
START押下後に `SFX.resume()` が解決されず、`scene.start("game")` へ進まないケースに対策を入れました。

- `StartScene` の `start()` に `RESUME_TIMEOUT_MS = 350` を追加
- `SFX.resume()` は `Promise.race()` で `350ms` まで待機
- 期限超過（timeout）や失敗（rejected）でも、ログを出してゲーム開始処理を継続
- `scene.start("game")` は音声初期化結果に関わらず呼ばれる

この変更で、音声初期化が不安定な環境でも、START後の画面遷移が止まりにくくなります。

### iPhone Chromeでタイトルが欠ける現象への対策
スタート画面のタイトル（`MATH LANE SHOOTER`）は `Orbitron` フォントで描画していますが、
起動前に待機していたのが `Rajdhani` だけだったため、端末や回線状況によってはタイトル生成時に代替フォントで一度描画され、
その後のフォント切替で字幅が変わって左右が欠けて見えることがありました。

そこで、ゲーム起動前のフォント待機対象を拡張し、次を読み込んでから `Phaser.Game` を起動するようにしました。

- `Rajdhani`（問題文・敵数字）
- `Orbitron`（タイトル）
- `Space Grotesk`（サブタイトル/UIラベル）

タイムアウト時のログ文言も「Rajdhani限定」から「Webフォント全体」に変更しています。
これにより、iPhone版Chromeでも起動直後のタイトル欠けが起きにくくなります。
