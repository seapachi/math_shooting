# EXPLANATION.md

## 1. このファイルの目的
この文書は、`Math Lane Shooter` のソースコードを初心者向けに読み解くためのガイドです。  
「どこに何があり、どう動いているか」を全体から順に理解できるように構成しています。

## 2. プロジェクト全体像
このゲームは「計算問題」と「4レーンシューティング」を組み合わせたブラウザゲームです。

- 表示とゲームロジックは `Phaser 3` で実装
- 見た目のテーマ（背景・色・雰囲気）は `styles.css` で管理
- 実行時に必要なのは `index.html` だけ（PhaserはCDN読み込み）

## 3. ファイル構成
- `index.html`
  - HTML土台
  - Phaser本体読み込み
  - ゲームロジック（JavaScript）全部
- `styles.css`
  - 背景グラデーション、星空レイヤー、UIテーマ色
  - レスポンシブや装飾アニメーション
- `mock-game.html`
  - 実装に接続していない「Game画面デザイン用モック」
  - 参照画像に合わせた明るいサイバー調のレイアウト確認用
- `mock-game.css`
  - `mock-game.html` 専用スタイル
  - グリッド背景、HUDカード、問題カード、回答ブロックの見た目を定義
- `README.md`
  - 現在の説明ドキュメントのコピー
- `AGENTS.md`
  - このリポジトリでの運用ルール

## 4. `index.html` の読み方（重要）
初心者向けには次の順で読むと理解しやすいです。

1. ユーティリティ関数
- `makeQuestion()`: 問題と選択肢を作る
- `hearts()`: ライフ表示文字列を作る
- `addStarfield()`: 背景の星を描く

2. 音関連
- `AudioLab`: Web Audio の低レベル制御（発振、ノイズ、音量エンベロープ）
- `SFX`: 効果音の用途別ラッパー（shoot/correct/wrong/miss/ui）

3. Sceneクラス
- `BootScene`: テクスチャ生成（自機、選択肢、弾）
- `StartScene`: タイトル画面、説明、スタート、機体スタイル選択
- `GameScene`: 実ゲーム本体
- `PauseScene`: 一時停止メニュー
- `GameOverScene`: 終了画面

4. 設定と起動
- `const config = {...}`
- `new Phaser.Game(config)`

## 5. ゲームの進行フロー
起動から終了までの流れは次の通りです。

1. `BootScene`
- 最初に図形からゲーム用テクスチャを作る
- 完了したら `start` シーンへ遷移

2. `StartScene`
- 背景やタイトルを描画
- 機体スタイル（`sharp` / `flare`）を選ぶ
- STARTで `GameScene` へ（初期スコアとライフを渡す）

3. `GameScene`
- レーン、UI、プレイヤー、入力処理を準備
- `newRound()` で問題を生成し、4つの答えを落下開始
- 判定後 `finishRound()` でスコア/ライフ更新
- 次ラウンドへ
- ライフ0で `GameOverScene`

4. `GameOverScene`
- 最終スコア表示
- RETRYで再スタート

## 6. `GameScene` の設計ポイント
ここが最重要です。

### 6-1. 状態（State）を持つ変数
`constructor` で主要な状態を持っています。

- 位置系: `lane`, `laneCenters`, `player`
- ラウンド系: `roundActive`, `roundFinished`, `question`
- スコア系: `score`, `lives`, `roundCount`, `currentSpeed`
- 入力補助: `lastTapTime`, `lastTapX`, `lastTapY`
- 物理系: `bullets`, `choiceSprites`, `choiceTexts`

この「状態変数」を中心に、関数が状態を更新してゲームが進みます。

### 6-2. 1ラウンドの流れ
`newRound()` で開始し、`finishRound()` で終了します。

1. `newRound()`
- 問題を作る（`makeQuestion()`）
- 4つの選択肢を別レーンに配置
- 下向き速度を設定（ラウンドが進むほど速く）

2. プレイヤー操作
- タップ/スワイプでレーン移動
- ダブルタップで発射（`shootAtLane()`）

3. 判定
- 直撃、またはジャッジライン到達時に正誤を決める

4. `finishRound(isCorrect)`
- 正解ならスコア+1
- 不正解/見逃しならライフ減少
- 少し待って次ラウンド

### 6-3. なぜ `roundActive` と `roundFinished` が両方あるのか
ゲームでは「同時イベント」が起きるためです。  
例えば同フレームで「弾ヒット」と「ライン到達」が重なる可能性があります。

- `roundActive`: 今ラウンドが進行中か
- `roundFinished`: もう判定済みか

この2つで二重判定を防ぎます。

## 7. 入力処理の考え方
`setupInput()` に集約されています。

- `pointerdown`
  - 基本は「レーン移動」
  - 前回タップとの時間・距離条件を満たすと「ダブルタップ発射」
- `pointerup`
  - 移動量と時間から「スワイプ」を判定

つまり1つのポインター入力から「移動」と「発射」を分岐させています。

## 8. 問題生成ロジック（`makeQuestion()`）
- `a - b` の形で問題を作る（答えは `0..20`）
- 正解を含む4択を作る
- 近い値（±1, ±2, ±3）を優先して混ぜる
- 足りなければランダムで補充
- 最後にシャッフル

学習ポイント:
- `Set` を使うと重複排除が簡単
- 先に「正解を必ず入れる」設計が安全

## 9. 音設計の考え方
音声ファイルではなく合成音（Web Audio）です。

- `AudioLab`
  - 発振器（`osc`）
  - ノイズ（`noise`）
  - 包絡（`env`）
- `SFX`
  - ゲームイベントごとに音を選ぶ薄い層

この分離で「音色づくり」と「ゲームイベント接続」が分かれ、保守しやすくなります。

## 10. 描画とデザインの役割分担
- `styles.css`
  - ページ背景、星空オーバーレイ、全体テーマ
- `index.html` 内の Phaser 描画
  - ゲーム中のUI、オブジェクト、アニメーション

つまり「DOM/CSSの見た目」と「Canvasゲーム内描画」を併用しています。

## 11. 初心者向け: まず触るべき場所
最初の改造はこの順がおすすめです。

1. `makeQuestion()` の数値範囲変更
2. `newRound()` の落下速度調整
3. `finishRound()` のスコア計算変更
4. `BootScene` の自機テクスチャ変更
5. `StartScene` の文言やUI調整

## 12. 今後の学習テーマ
- PhaserのSceneライフサイクル（`init`, `create`, `update`）
- Arcade Physics の当たり判定
- 状態管理（フラグ設計と二重実行防止）
- 入力ジェスチャー判定（タップ/ダブルタップ/スワイプ）
- Web Audio の基礎

## 13. 要約
このコードは「1ファイルに集約された小規模ゲーム」として読みやすく、  
以下の実践が詰まっています。

- Scene分割で責務を分ける
- 状態フラグで競合を防ぐ
- ロジックと演出を分離する
- 小さな関数を組み合わせて全体を作る

初心者が「ゲーム開発の全体構造」を学ぶ教材として、かなり良い構成です。

## 14. 最近の変更
- `mock-game.css` を調整し、`reference/image.png` に寄せて HUD のサイズ感、余白、配色バランスを微調整しました。
- `mock-game.html` の選択肢を4つに変更しました（ゲーム仕様に合わせるため）。
- `mock-game.css` のレイアウト位置を再調整し、4レーン前提で回答カードとロックライン、自機位置の整合を改善しました。
- `mock-game.css` の上下余白を再調整し、上部HUDから下部自機までの密度を参照画像に近づけました。
- `styles.css` のテーマカラーで `#f472b6` を `#4CC9FF` に置き換えました（アクセントと選択肢色）。
- `index.html` の選択肢テクスチャ色を `0xf472b6` から `0x4cc9ff` に変更しました。
- `styles.css` のアクセント色と選択肢色を `#8B5CF6` に変更し、`index.html` の選択肢テクスチャ色も `0x8b5cf6` に揃えました。
